apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: backup-monitor
data:
  01-schema.sql: |
    CREATE TABLE IF NOT EXISTS telemetry_events (
        id               BIGSERIAL PRIMARY KEY,
        received_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        source_ip        TEXT,
        event            VARCHAR(50) NOT NULL,
        fingerprint      VARCHAR(16),
        environment      VARCHAR(20),
        env_source       VARCHAR(100),
        public_ip        TEXT,
        server_url       TEXT,
        provider         VARCHAR(20),
        node_count       INTEGER,
        cp_nodes         INTEGER,
        namespace_count  INTEGER,
        k10_version      VARCHAR(50),
        enterprise_score INTEGER,
        license_key_provided BOOLEAN,
        license_key_valid    BOOLEAN,
        unlicensed_run_count INTEGER,
        src_hash         VARCHAR(16),
        tool_version     VARCHAR(20),
        client_timestamp TIMESTAMPTZ,
        raw_payload      JSONB NOT NULL
    );

    CREATE INDEX IF NOT EXISTS idx_telemetry_fingerprint ON telemetry_events (fingerprint);
    CREATE INDEX IF NOT EXISTS idx_telemetry_received_at ON telemetry_events (received_at DESC);

    CREATE TABLE IF NOT EXISTS dns_beacon_log (
        id           BIGSERIAL PRIMARY KEY,
        received_at  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        source_ip    TEXT,
        source_port  INTEGER,
        query_name   TEXT NOT NULL,
        fingerprint  VARCHAR(16),
        src_hash     VARCHAR(16),
        tool_version VARCHAR(20)
    );

    CREATE INDEX IF NOT EXISTS idx_dns_fingerprint ON dns_beacon_log (fingerprint);
    CREATE INDEX IF NOT EXISTS idx_dns_received_at ON dns_beacon_log (received_at DESC);
